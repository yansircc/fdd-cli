/**
 * Husky hook generation
 * Generates .husky/{hookName} files
 */

import { existsSync } from "node:fs";
import { chmod, writeFile } from "node:fs/promises";
import { join } from "node:path";

export interface HuskyGenerateResult {
	success: boolean;
	ref: string;
	error?: string;
}

export async function generateHuskyHook(
	cwd: string,
	hookName: string, // e.g., "pre-push", "pre-commit"
	script: string,
	pitfallId: string,
): Promise<HuskyGenerateResult> {
	const hookPath = join(cwd, ".husky", hookName);
	const ref = `.husky/${hookName}`;

	// Check if hook already exists
	if (existsSync(hookPath)) {
		return {
			success: false,
			ref,
			error: `Hook ${ref} already exists. FDD will not overwrite existing hooks.`,
		};
	}

	// Generate script with FDD header comment
	const content = `#!/bin/sh
# FDD: Generated by ${pitfallId}
# DO NOT EDIT - managed by fdd-cli

${script}
`;

	await writeFile(hookPath, content, "utf-8");
	await chmod(hookPath, 0o755); // Make executable

	return { success: true, ref };
}

/**
 * Check if a husky hook exists
 */
export function huskyHookExists(cwd: string, hookName: string): boolean {
	const hookPath = join(cwd, ".husky", hookName);
	return existsSync(hookPath);
}
